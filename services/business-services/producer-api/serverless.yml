service: job-manager-producer

build:
  esbuild: true

custom:
  resources: ${file(../../../config/config.${self:provider.stage}.yml)}

provider:
  name: aws
  runtime: nodejs22.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'eu-west-1'}
  profile: ${self:custom.resources.profile, 'default'}
  stackTags:
    Team: job-manager-producer-${self:provider.stage}
  environment:
    ENVIRONMENT: ${self:provider.stage}
    EVENTS_TABLE: events-${self:provider.stage}
    EVENT_BUS_NAME: job-manager-${self:provider.stage}
    TENANT_ID: gbInnovations
    APP_NAME: task-workflow
  apiGateway:
    apiKeys:
      - name: producer-api-key-${self:provider.stage}
    usagePlan:
      quota:
        limit: 10000
        period: DAY
      throttle:
        burstLimit: 50
        rateLimit: 100

functions:

  create-job:
    handler: src/handlers/create-job.handler
    description: Creates a new job with task DAG
    timeout: 30
    memorySize: 256
    events:
      - http:
          path: /jobs
          method: post
          private: true
    iamRoleStatements:
      - Effect: Allow
        Action: events:PutEvents
        Resource: "*"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}/index/*

  add-tasks:
    handler: src/handlers/add-tasks.handler
    description: Adds tasks to an existing job
    timeout: 30
    memorySize: 256
    events:
      - http:
          path: /jobs/{jobId}/tasks
          method: post
          private: true
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}/index/*
      - Effect: Allow
        Action: events:PutEvents
        Resource: "*"

  list-jobs:
    handler: src/handlers/list-jobs.handler
    description: Lists all jobs with status
    timeout: 30
    memorySize: 256
    events:
      - http:
          path: /jobs
          method: get
          private: true
    iamRoleStatements:
      - Effect: Allow
        Action: dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}/index/*

  get-job:
    handler: src/handlers/get-job.handler
    description: Gets job details with task statuses
    timeout: 30
    memorySize: 256
    events:
      - http:
          path: /jobs/{jobId}
          method: get
          private: true
    iamRoleStatements:
      - Effect: Allow
        Action: dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}/index/*
