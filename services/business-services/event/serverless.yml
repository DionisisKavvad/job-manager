service: job-manager-event

build:
  esbuild: true

custom:
  resources: ${file(../../../config/config.${self:provider.stage}.yml)}

provider:
  name: aws
  runtime: nodejs22.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'eu-west-1'}
  profile: ${self:custom.resources.profile, 'default'}
  stackTags:
    Team: job-manager-event-${self:provider.stage}
  environment:
    ENVIRONMENT: ${self:provider.stage}
    EVENTS_TABLE: events-${self:provider.stage}
    EVENT_BUS_NAME: job-manager-${self:provider.stage}
    TENANT_ID: gbInnovations
    APP_NAME: task-workflow

functions:

  save-event-to-dynamo:
    handler: src/save-event-to-dynamo.handler
    description: Persists all events from EventBridge to DynamoDB
    timeout: 30
    memorySize: 256
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}

  dlq-processor:
    handler: src/dlq-processor.handler
    description: Emits terminal Task Failed for DLQ messages
    timeout: 30
    memorySize: 256
    events:
      - sqs:
          arn: arn:aws:sqs:${self:provider.region}:${aws:accountId}:task-queue-dlq-${self:provider.stage}
          batchSize: 1
    iamRoleStatements:
      - Effect: Allow
        Action:
          - events:PutEvents
        Resource: "*"

  eventbridge-dlq-alert:
    handler: src/eventbridge-dlq-alert.handler
    description: Slack alert when EventBridge fails to deliver events
    timeout: 30
    memorySize: 256
    environment:
      SLACK_WEBHOOK_URL: ${self:custom.resources.slackWebhookUrl}
    events:
      - sqs:
          arn: !GetAtt EventBridgeTargetDLQ.Arn
          batchSize: 1

resources:
  Resources:

    SaveEventRule:
      Type: AWS::Events::Rule
      Properties:
        Name: ${self:provider.stage}-save-event-to-dynamo
        EventBusName: job-manager-${self:provider.stage}
        EventPattern:
          detail-type:
            - "log-event"
        Targets:
          - Arn: !GetAtt SaveDasheventDashtoDashdynamoLambdaFunction.Arn
            Id: save-event-target
            DeadLetterConfig:
              Arn: !GetAtt EventBridgeTargetDLQ.Arn
            RetryPolicy:
              MaximumRetryAttempts: 3
              MaximumEventAgeInSeconds: 3600

    SaveEventPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !Ref SaveDasheventDashtoDashdynamoLambdaFunction
        Action: lambda:InvokeFunction
        Principal: events.amazonaws.com
        SourceArn: !GetAtt SaveEventRule.Arn

    EventBridgeTargetDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:provider.stage}-eventbridge-target-dlq
        MessageRetentionPeriod: 1209600

    EventBridgeTargetDLQPolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - !Ref EventBridgeTargetDLQ
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: events.amazonaws.com
              Action: sqs:SendMessage
              Resource: !GetAtt EventBridgeTargetDLQ.Arn
