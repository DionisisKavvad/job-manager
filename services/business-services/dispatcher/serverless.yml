service: job-manager-dispatcher

build:
  esbuild: true

custom:
  resources: ${file(../../../config/config.${self:provider.stage}.yml)}

provider:
  name: aws
  runtime: nodejs22.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'eu-west-1'}
  profile: ${self:custom.resources.profile, 'default'}
  stackTags:
    Team: job-manager-dispatcher-${self:provider.stage}
  environment:
    ENVIRONMENT: ${self:provider.stage}
    TASK_QUEUE_URL: https://sqs.${self:provider.region}.amazonaws.com/${aws:accountId}/task-queue-${self:provider.stage}
    EVENTS_TABLE: events-${self:provider.stage}
    EVENT_BUS_NAME: job-manager-${self:provider.stage}
    TENANT_ID: gbInnovations
    APP_NAME: task-workflow

functions:

  task-dispatcher:
    handler: src/task-dispatcher.handler
    description: Dispatches next tasks when DAG dependencies are met
    timeout: 30
    memorySize: 256
    events:
      - eventBridge:
          eventBus: arn:aws:events:${self:provider.region}:${aws:accountId}:event-bus/job-manager-${self:provider.stage}
          pattern:
            detail-type:
              - "log-event"
            detail:
              eventType:
                - "Task Approved"
                - "Task Failed"
    iamRoleStatements:
      - Effect: Allow
        Action: dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}/index/*
      - Effect: Allow
        Action: events:PutEvents
        Resource: "*"

  review-notifier:
    handler: src/review-notifier.handler
    description: Sends review notification when task is submitted for review
    timeout: 10
    memorySize: 256
    events:
      - eventBridge:
          eventBus: arn:aws:events:${self:provider.region}:${aws:accountId}:event-bus/job-manager-${self:provider.stage}
          pattern:
            detail-type:
              - "log-event"
            detail:
              eventType:
                - "Task Submitted For Review"
    iamRoleStatements:
      - Effect: Allow
        Action: sqs:SendMessage
        Resource: arn:aws:sqs:${self:provider.region}:${aws:accountId}:task-queue-${self:provider.stage}

  task-enqueuer:
    handler: src/task-enqueuer.handler
    description: Reads Task Saved from DynamoDB and forwards to SQS
    timeout: 15
    memorySize: 256
    events:
      - eventBridge:
          eventBus: arn:aws:events:${self:provider.region}:${aws:accountId}:event-bus/job-manager-${self:provider.stage}
          pattern:
            detail-type:
              - "log-event"
            detail:
              eventType:
                - "Task Pending"
    iamRoleStatements:
      - Effect: Allow
        Action: sqs:SendMessage
        Resource: arn:aws:sqs:${self:provider.region}:${aws:accountId}:task-queue-${self:provider.stage}
      - Effect: Allow
        Action: dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}
          - arn:aws:dynamodb:${self:provider.region}:${aws:accountId}:table/events-${self:provider.stage}/index/*
