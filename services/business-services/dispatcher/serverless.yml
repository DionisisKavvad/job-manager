service: job-manager-dispatcher

build:
  esbuild: true

custom:
  resources: ${file(../../../config/config.${self:provider.stage}.yml)}
  imports:
    queueUrl: !ImportValue job-manager-queue-url-${self:provider.stage}
    queueArn: !ImportValue job-manager-queue-arn-${self:provider.stage}
    eventsTableName: !ImportValue job-manager-events-table-name-${self:provider.stage}
    eventsTableArn: !ImportValue job-manager-events-table-arn-${self:provider.stage}
    eventBusName: !ImportValue job-manager-event-bus-name-${self:provider.stage}

provider:
  name: aws
  runtime: nodejs22.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'eu-west-1'}
  profile: ${self:custom.resources.profile, 'default'}
  stackTags:
    Team: job-manager-dispatcher-${self:provider.stage}
  environment:
    ENVIRONMENT: ${self:provider.stage}
    TASK_QUEUE_URL: ${self:custom.imports.queueUrl}
    EVENTS_TABLE: ${self:custom.imports.eventsTableName}
    EVENT_BUS_NAME: ${self:custom.imports.eventBusName}
    TENANT_ID: gbInnovations
    APP_NAME: task-workflow

functions:

  task-dispatcher:
    handler: src/task-dispatcher.handler
    description: Dispatches next tasks when DAG dependencies are met
    timeout: 30
    memorySize: 256
    events:
      - eventBridge:
          eventBus: ${self:custom.imports.eventBusName}
          pattern:
            detail-type:
              - "log-event"
            detail:
              eventType:
                - "Task Completed"
                - "Task Approved"
                - "Task Failed"
    iamRoleStatements:
      - Effect: Allow
        Action: dynamodb:Query
        Resource:
          - ${self:custom.imports.eventsTableArn}
          - ${self:custom.imports.eventsTableArn}/index/*
      - Effect: Allow
        Action: sqs:SendMessage
        Resource: ${self:custom.imports.queueArn}
      - Effect: Allow
        Action: events:PutEvents
        Resource: "*"
